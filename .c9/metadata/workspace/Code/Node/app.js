{"changed":true,"filter":false,"title":"app.js","tooltip":"/Code/Node/app.js","value":"const model = require(\"./model.js\");\nconst wirelessTransmitter = require(\"./wireless-transmitter.js\");\nconst camConnector = require(\"./cam-connector.js\");\nconst express = require('express');\nconst bodyParser = require(\"body-parser\");\n\nconst app = express();\n\n\napp.use(express.static('public'));\n\napp.use(\"/styles\", express.static(__dirname + '/public/css'));\napp.use(\"/scripts\", express.static(__dirname + '/public/js'));\napp.use(\"/images\", express.static(__dirname + '/public/images'));\n\n\n\n\n\n/* Webinterface */\n\n// parse application/x-www-form-urlencoded\napp.use(bodyParser.urlencoded({ extended: false }));\n\n// parse application/json\napp.use(bodyParser.json());\n\napp.get('/', function(req, res) {\n  res.sendfile(__dirname + '/public/index.html');\n});\n\napp.get('/discovery', function(req, res) {\n  let endpointInformation = JSON.stringify(model.getEndpointInformation());\n  console.log(`DISCOVERY-Request`, endpointInformation);\n  res.send(endpointInformation);\n});\n\napp.post('/report-state', function(req, res) {\n  let deviceAttempt = req.body;\n  let device = model.getDevice(deviceAttempt);\n\n  console.log(JSON.stringify(device));\n  res.send(JSON.stringify(device));\n});\n\napp.post('/power-controller', function(req, res) {\n\n  updateDevice(req.body, (updatedDevice, id, status) => {\n    res.send(JSON.stringify(updatedDevice));\n\n    if (id != 99) { /* not \"All\" */\n      toWirelessTransmitter(id, status);\n    }\n    else {\n      id = 1;\n      let interval = setInterval(() => {\n        toWirelessTransmitter(id, status);\n        id *= 2;\n        if (id === 8) {\n          clearInterval(interval);\n        }\n\n      }, 1000);\n    }\n\n\n\n  });\n\n});\n\napp.post('/cam-controller', function(req, res) {\n\n  updateDevice(req.body, (updatedDevice, id, status) => {\n    res.send(JSON.stringify(updatedDevice));\n\n    camConnector.switchOnOff(status);\n  });\n\n});\n\n\nlet updateDevice = (data, callback) => {\n\n  let deviceUpdateAttempt = data;\n  console.log(JSON.stringify(deviceUpdateAttempt));\n\n\n  let updatedDevice = model.updateDevice(deviceUpdateAttempt);\n  let id = updatedDevice.switchId;\n\n  let status = 0;\n  for (let property of updatedDevice.properties) {\n    if (property.namespace === \"Alexa.PowerController\" && property.name === \"powerState\") {\n      status = property.value;\n    }\n  }\n\n\n  callback(updatedDevice, id, status);\n};\n\n\n<<<<<<<<< saved version\nlet toWirelessTransmitter = (id, status) => {\n=========\n\nlet toPythonScript = (id, status) => {\n>>>>>>>>> local version\n\n  let timeOfLastProcess = new Date(model.getData().timeOfLastUpdate);\n  let timeNow = new Date();\n  let delta = 500;\n\n  //console.log(\"timeNow: \" + timeNow, \"timeOfLastProcess: \" + timeOfLastProcess, \"timeOfLastProcess + delta - timeNow: \" + (timeOfLastProcess.getTime() + delta - timeNow.getTime()));\n  if (timeOfLastProcess.getTime() + delta > timeNow.getTime()) {\n    setTimeout(() => { toWirelessTransmitter(id, status) }, 100);\n  }\n  else {\n    callProcess(id, status);\n  }\n\n\n};\n\nlet callProcess = (id, status) => {\n\n<<<<<<<<< saved version\n\n=========\n  /*\n  model.setTimeOfLastUpdate(new Date());\n  let spawn = require(\"child_process\").spawn;\n  let process = spawn('python', [\"../elropi.py\", id, 1]);\n\n\n  process.stdout.on('data', function(data) {\n    console.log(data.toString('utf8')); // buffer to string);\n  });\n<<<<<<<<< saved version\n  */\n<<<<<<<<< saved version\n\n\n=========\n  });\n  */\n=========\n=========\n<<<<<<<<< saved version\n\n=========\n    console.log(data.toString('utf8')); // buffer to string);\n  });\n<<<<<<<<< saved version\n\n=========\n    console.log(data.toString('utf8')); // buffer to string);\n  });\n  */\n<<<<<<<<< saved version\n  */\n>>>>>>>>> local version\n  \n<<<<<<<<< saved version\n  */\n  \n<<<<<<<<< saved version\n  \n=========\n  });\n  */\n<<<<<<<<< saved version\n  */\n  \n=========\n\n>>>>>>>>> local version\n>>>>>>>>> local version\n>>>>>>>>> local version\n>>>>>>>>> local version\n>>>>>>>>> local version\n  \n  \n>>>>>>>>> local version\n>>>>>>>>> local version\n  model.setTimeOfLastUpdate(new Date());\n  wirelessTransmitter.transmitToWirelessSwitch(id, status, \"01110\"); //TODD: change to webinterface input!\n\n<<<<<<<<< saved version\n};\n=========\n=========\n=========\n>>>>>>>>> local version\n\n\napp.listen(3000, function() {\n  console.log('Example app listening on port 3000!');\n\n});\n","undoManager":{"mark":-2,"position":10,"stack":[[{"start":{"row":1,"column":6},"end":{"row":2,"column":6},"action":"insert","lines":["wirelessTransmitter = require(\"./wireless-transmitter.js\")","const "],"id":1},{"start":{"row":110,"column":2},"end":{"row":111,"column":2},"action":"insert","lines":["/*","  "]},{"start":{"row":118,"column":5},"end":{"row":126,"column":0},"action":"insert","lines":["","    console.log(data.toString('utf8')); // buffer to string);","  });","  */","","  model.setTimeOfLastUpdate(new Date());","  wirelessTransmitter.transmitToWirelessSwitch(id, status, \"01110\"); //TODD: change to webinterface input!","",""]}],[{"start":{"row":61,"column":6},"end":{"row":61,"column":8},"action":"insert","lines":["//"],"id":2},{"start":{"row":61,"column":48},"end":{"row":62,"column":29},"action":"insert","lines":[";","      status = property.value"]},{"start":{"row":122,"column":2},"end":{"row":124,"column":2},"action":"insert","lines":["  console.log(data.toString('utf8')); // buffer to string);","  });","  "]},{"start":{"row":125,"column":0},"end":{"row":130,"column":23},"action":"insert","lines":["<<<<<<<<< saved version","  */","  ","=========","",">>>>>>>>> local version"]}],[{"start":{"row":61,"column":6},"end":{"row":61,"column":8},"action":"remove","lines":["//"],"id":3},{"start":{"row":61,"column":46},"end":{"row":62,"column":29},"action":"remove","lines":[";","      status = property.value"]},{"start":{"row":127,"column":0},"end":{"row":129,"column":0},"action":"insert","lines":["<<<<<<<<< saved version","  ",""]},{"start":{"row":130,"column":0},"end":{"row":137,"column":23},"action":"insert","lines":["  });","  */","<<<<<<<<< saved version","  */","  ","=========","",">>>>>>>>> local version"]}],[{"start":{"row":61,"column":6},"end":{"row":61,"column":8},"action":"insert","lines":["//"],"id":4},{"start":{"row":61,"column":48},"end":{"row":62,"column":29},"action":"insert","lines":[";","      status = property.value"]},{"start":{"row":111,"column":2},"end":{"row":111,"column":4},"action":"remove","lines":["/*"]},{"start":{"row":122,"column":0},"end":{"row":125,"column":0},"action":"insert","lines":["<<<<<<<<< saved version","","=========",""]},{"start":{"row":130,"column":0},"end":{"row":134,"column":0},"action":"insert","lines":[">>>>>>>>> local version","  ","<<<<<<<<< saved version","  */",""]},{"start":{"row":147,"column":2},"end":{"row":148,"column":4},"action":"insert","lines":["","  //"]},{"start":{"row":149,"column":2},"end":{"row":149,"column":4},"action":"insert","lines":["//"]}],[{"start":{"row":120,"column":0},"end":{"row":123,"column":0},"action":"insert","lines":["<<<<<<<<< saved version","","=========",""],"id":5},{"start":{"row":147,"column":0},"end":{"row":148,"column":23},"action":"insert","lines":["",">>>>>>>>> local version"]}],[{"start":{"row":114,"column":53},"end":{"row":114,"column":59},"action":"remove","lines":["status"],"id":6},{"start":{"row":114,"column":53},"end":{"row":114,"column":54},"action":"insert","lines":["1"]}],[{"start":{"row":111,"column":2},"end":{"row":111,"column":4},"action":"insert","lines":["/*"],"id":7},{"start":{"row":119,"column":5},"end":{"row":122,"column":9},"action":"insert","lines":["","<<<<<<<<< saved version","  */","========="]},{"start":{"row":154,"column":0},"end":{"row":154,"column":9},"action":"insert","lines":[">>>>>>>>>"]},{"start":{"row":154,"column":10},"end":{"row":154,"column":15},"action":"insert","lines":["local"]},{"start":{"row":154,"column":16},"end":{"row":154,"column":23},"action":"insert","lines":["version"]},{"start":{"row":155,"column":2},"end":{"row":155,"column":4},"action":"remove","lines":["//"]},{"start":{"row":155,"column":2},"end":{"row":157,"column":2},"action":"insert","lines":["","  ","  "]},{"start":{"row":158,"column":2},"end":{"row":158,"column":4},"action":"remove","lines":["//"]}],[{"start":{"row":0,"column":35},"end":{"row":0,"column":36},"action":"insert","lines":[";"],"id":8},{"start":{"row":1,"column":64},"end":{"row":2,"column":51},"action":"insert","lines":[";","const camConnector = require(\"./cam-connector.js\");"]}],[{"start":{"row":101,"column":25},"end":{"row":101,"column":30},"action":"remove","lines":["Pytho"],"id":9},{"start":{"row":101,"column":25},"end":{"row":101,"column":36},"action":"insert","lines":["WirelessTra"]},{"start":{"row":101,"column":37},"end":{"row":101,"column":40},"action":"remove","lines":["Scr"]},{"start":{"row":101,"column":37},"end":{"row":101,"column":39},"action":"insert","lines":["sm"]},{"start":{"row":101,"column":40},"end":{"row":101,"column":41},"action":"remove","lines":["p"]},{"start":{"row":101,"column":41},"end":{"row":101,"column":44},"action":"insert","lines":["ter"]},{"start":{"row":123,"column":0},"end":{"row":138,"column":0},"action":"insert","lines":["<<<<<<<<< saved version","","let callProcess = (id, status) => {","","  /*","  model.setTimeOfLastUpdate(new Date());","  let spawn = require(\"child_process\").spawn;","  let process = spawn('python', [\"../elropi.py\", id, 1]);","","","  process.stdout.on('data', function(data) {","    console.log(data.toString('utf8')); // buffer to string);","  });","  */","=========",""]},{"start":{"row":166,"column":0},"end":{"row":167,"column":23},"action":"insert","lines":["",">>>>>>>>> local version"]}],[{"start":{"row":46,"column":0},"end":{"row":47,"column":0},"action":"remove","lines":["",""],"id":10},{"start":{"row":46,"column":2},"end":{"row":46,"column":90},"action":"remove","lines":["console.log(`type: ${typeof(req.body)}`, `JSON.stringify: ${JSON.stringify(req.body)}`);"]},{"start":{"row":47,"column":2},"end":{"row":47,"column":13},"action":"remove","lines":["let deviceU"]},{"start":{"row":47,"column":2},"end":{"row":47,"column":3},"action":"insert","lines":["u"]},{"start":{"row":47,"column":8},"end":{"row":48,"column":30},"action":"remove","lines":["Attempt = req.body;","  console.log(JSON.stringify(d"]},{"start":{"row":47,"column":8},"end":{"row":47,"column":9},"action":"insert","lines":["D"]},{"start":{"row":47,"column":14},"end":{"row":48,"column":15},"action":"remove","lines":["UpdateAttempt));","  //console.log"]},{"start":{"row":47,"column":23},"end":{"row":49,"column":33},"action":"remove","lines":[");","  //testing python execution","  //let id = parseInt(req.body.id"]},{"start":{"row":47,"column":25},"end":{"row":48,"column":25},"action":"remove","lines":["10);","  //let status = parseInt"]},{"start":{"row":47,"column":26},"end":{"row":48,"column":6},"action":"remove","lines":["req.body.status, 10);","  let "]},{"start":{"row":47,"column":39},"end":{"row":47,"column":40},"action":"insert","lines":[","]},{"start":{"row":47,"column":41},"end":{"row":47,"column":58},"action":"remove","lines":["= model.updateDev"]},{"start":{"row":47,"column":42},"end":{"row":47,"column":45},"action":"remove","lines":["ce("]},{"start":{"row":47,"column":43},"end":{"row":50,"column":5},"action":"remove","lines":["eviceUpdateAttempt);","  let id = updatedDevice.switchId;","","  let"]},{"start":{"row":47,"column":43},"end":{"row":47,"column":44},"action":"insert","lines":[","]},{"start":{"row":47,"column":51},"end":{"row":47,"column":52},"action":"insert","lines":[")"]},{"start":{"row":47,"column":54},"end":{"row":47,"column":55},"action":"insert","lines":[">"]},{"start":{"row":47,"column":56},"end":{"row":47,"column":58},"action":"remove","lines":["0;"]},{"start":{"row":47,"column":56},"end":{"row":47,"column":57},"action":"insert","lines":["{"]},{"start":{"row":48,"column":2},"end":{"row":48,"column":5},"action":"remove","lines":["for"]},{"start":{"row":48,"column":3},"end":{"row":48,"column":7},"action":"remove","lines":["(let"]},{"start":{"row":48,"column":4},"end":{"row":48,"column":5},"action":"remove","lines":["p"]},{"start":{"row":48,"column":5},"end":{"row":48,"column":37},"action":"remove","lines":["operty of updatedDevice.properti"]},{"start":{"row":48,"column":7},"end":{"row":49,"column":16},"action":"remove","lines":[") {","    if (property"]},{"start":{"row":48,"column":8},"end":{"row":48,"column":12},"action":"remove","lines":["name"]},{"start":{"row":48,"column":9},"end":{"row":48,"column":12},"action":"remove","lines":["pac"]},{"start":{"row":48,"column":10},"end":{"row":48,"column":29},"action":"remove","lines":[" === \"Alexa.PowerCo"]},{"start":{"row":48,"column":11},"end":{"row":48,"column":47},"action":"remove","lines":["troller\" && property.name === \"power"]},{"start":{"row":48,"column":11},"end":{"row":48,"column":14},"action":"insert","lines":["d(J"]},{"start":{"row":48,"column":15},"end":{"row":48,"column":19},"action":"insert","lines":["ON.s"]},{"start":{"row":48,"column":20},"end":{"row":50,"column":11},"action":"remove","lines":["ate\") {","","      /* te"]},{"start":{"row":48,"column":21},"end":{"row":48,"column":22},"action":"insert","lines":["i"]},{"start":{"row":48,"column":23},"end":{"row":48,"column":25},"action":"remove","lines":["ar"]},{"start":{"row":48,"column":23},"end":{"row":48,"column":26},"action":"insert","lines":["gif"]},{"start":{"row":48,"column":27},"end":{"row":48,"column":29},"action":"remove","lines":[" o"]},{"start":{"row":48,"column":27},"end":{"row":48,"column":29},"action":"insert","lines":["(u"]},{"start":{"row":48,"column":30},"end":{"row":49,"column":10},"action":"remove","lines":["erator */","      //st"]},{"start":{"row":48,"column":30},"end":{"row":48,"column":31},"action":"insert","lines":["d"]},{"start":{"row":48,"column":33},"end":{"row":48,"column":42},"action":"remove","lines":["us = prop"]},{"start":{"row":48,"column":34},"end":{"row":48,"column":42},"action":"remove","lines":["rty.valu"]},{"start":{"row":48,"column":34},"end":{"row":48,"column":36},"action":"insert","lines":["dD"]},{"start":{"row":48,"column":37},"end":{"row":49,"column":24},"action":"remove","lines":[" === \"ON\" ? 1 : 0;","      status = property."]},{"start":{"row":48,"column":38},"end":{"row":48,"column":41},"action":"remove","lines":["alu"]},{"start":{"row":48,"column":38},"end":{"row":48,"column":40},"action":"insert","lines":["ic"]},{"start":{"row":48,"column":41},"end":{"row":48,"column":43},"action":"insert","lines":["))"]},{"start":{"row":49,"column":4},"end":{"row":52,"column":0},"action":"remove","lines":["}","  }","",""]},{"start":{"row":51,"column":6},"end":{"row":51,"column":11},"action":"remove","lines":["Pytho"]},{"start":{"row":51,"column":6},"end":{"row":51,"column":17},"action":"insert","lines":["WirelessTra"]},{"start":{"row":51,"column":18},"end":{"row":51,"column":21},"action":"remove","lines":["Scr"]},{"start":{"row":51,"column":18},"end":{"row":51,"column":20},"action":"insert","lines":["sm"]},{"start":{"row":51,"column":21},"end":{"row":51,"column":22},"action":"remove","lines":["p"]},{"start":{"row":51,"column":22},"end":{"row":51,"column":25},"action":"insert","lines":["ter"]},{"start":{"row":56,"column":8},"end":{"row":56,"column":13},"action":"remove","lines":["Pytho"]},{"start":{"row":56,"column":8},"end":{"row":56,"column":19},"action":"insert","lines":["WirelessTra"]},{"start":{"row":56,"column":20},"end":{"row":56,"column":23},"action":"remove","lines":["Scr"]},{"start":{"row":56,"column":20},"end":{"row":56,"column":22},"action":"insert","lines":["sm"]},{"start":{"row":56,"column":23},"end":{"row":56,"column":24},"action":"remove","lines":["p"]},{"start":{"row":56,"column":24},"end":{"row":56,"column":27},"action":"insert","lines":["ter"]},{"start":{"row":64,"column":0},"end":{"row":64,"column":4},"action":"insert","lines":["    "]},{"start":{"row":65,"column":2},"end":{"row":74,"column":4},"action":"insert","lines":["  ","    ","  });","  ","});","","app.post('/cam-controller', function(req, res) {","  ","  updateDevice(req.body, (updatedDevice, id, status) => {","    "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":4},"action":"insert","lines":["    "]},{"start":{"row":76,"column":0},"end":{"row":77,"column":2},"action":"insert","lines":["    camConnector.switchOnOff(status);","  "]},{"start":{"row":78,"column":0},"end":{"row":78,"column":2},"action":"insert","lines":["  "]},{"start":{"row":79,"column":0},"end":{"row":79,"column":3},"action":"insert","lines":["});"]},{"start":{"row":81,"column":0},"end":{"row":100,"column":2},"action":"insert","lines":["","let updateDevice = (data, callback) => {","  ","  let deviceUpdateAttempt = data;","  console.log(JSON.stringify(deviceUpdateAttempt));","","","  let updatedDevice = model.updateDevice(deviceUpdateAttempt);","  let id = updatedDevice.switchId;","","  let status = 0;","  for (let property of updatedDevice.properties) {","    if (property.namespace === \"Alexa.PowerController\" && property.name === \"powerState\") {","      status = property.value;","    }","  }","","  ","  callback(updatedDevice, id, status);","};"]},{"start":{"row":136,"column":0},"end":{"row":136,"column":16},"action":"remove","lines":["let callProcess "]},{"start":{"row":136,"column":0},"end":{"row":137,"column":0},"action":"insert","lines":["",""]},{"start":{"row":137,"column":1},"end":{"row":137,"column":15},"action":"remove","lines":[" (id, status) "]},{"start":{"row":137,"column":1},"end":{"row":137,"column":6},"action":"insert","lines":["====="]},{"start":{"row":137,"column":7},"end":{"row":141,"column":12},"action":"remove","lines":["> {","","  /*","  model.setTimeOfLastUpdate(new Date());","  let spawn "]},{"start":{"row":137,"column":8},"end":{"row":138,"column":14},"action":"remove","lines":[" require(\"child_process\").spawn;","  let process "]},{"start":{"row":137,"column":9},"end":{"row":141,"column":61},"action":"remove","lines":[" spawn('python', [\"../elropi.py\", id, 1]);","","","  process.stdout.on('data', function(data) {","    console.log(data.toString('utf8')); // buffer to string);"]},{"start":{"row":176,"column":2},"end":{"row":177,"column":23},"action":"insert","lines":["",">>>>>>>>> local version"]}],[{"start":{"row":46,"column":0},"end":{"row":46,"column":2},"action":"remove","lines":["  "],"id":11},{"start":{"row":49,"column":0},"end":{"row":49,"column":2},"action":"remove","lines":["  "]},{"start":{"row":49,"column":0},"end":{"row":50,"column":0},"action":"insert","lines":["",""]},{"start":{"row":50,"column":2},"end":{"row":51,"column":0},"action":"remove","lines":["",""]},{"start":{"row":51,"column":0},"end":{"row":51,"column":1},"action":"insert","lines":[" "]},{"start":{"row":51,"column":5},"end":{"row":51,"column":6},"action":"insert","lines":[" "]},{"start":{"row":52,"column":2},"end":{"row":52,"column":4},"action":"insert","lines":["  "]},{"start":{"row":53,"column":0},"end":{"row":53,"column":2},"action":"insert","lines":["  "]},{"start":{"row":54,"column":4},"end":{"row":54,"column":6},"action":"insert","lines":["  "]},{"start":{"row":55,"column":0},"end":{"row":55,"column":2},"action":"insert","lines":["  "]},{"start":{"row":56,"column":0},"end":{"row":56,"column":1},"action":"insert","lines":[" "]},{"start":{"row":56,"column":7},"end":{"row":56,"column":8},"action":"insert","lines":[" "]},{"start":{"row":57,"column":6},"end":{"row":57,"column":8},"action":"insert","lines":["  "]},{"start":{"row":58,"column":0},"end":{"row":58,"column":2},"action":"insert","lines":["  "]},{"start":{"row":59,"column":8},"end":{"row":59,"column":10},"action":"insert","lines":["  "]},{"start":{"row":60,"column":6},"end":{"row":60,"column":8},"action":"insert","lines":["  "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":2},"action":"insert","lines":["  "]},{"start":{"row":62,"column":15},"end":{"row":63,"column":3},"action":"remove","lines":["","  }"]},{"start":{"row":63,"column":4},"end":{"row":63,"column":5},"action":"insert","lines":["}"]},{"start":{"row":64,"column":0},"end":{"row":64,"column":4},"action":"remove","lines":["    "]},{"start":{"row":65,"column":0},"end":{"row":65,"column":4},"action":"remove","lines":["    "]},{"start":{"row":65,"column":0},"end":{"row":66,"column":0},"action":"insert","lines":["",""]},{"start":{"row":68,"column":0},"end":{"row":68,"column":2},"action":"remove","lines":["  "]},{"start":{"row":72,"column":0},"end":{"row":72,"column":2},"action":"remove","lines":["  "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":4},"action":"remove","lines":["    "]},{"start":{"row":78,"column":0},"end":{"row":78,"column":2},"action":"remove","lines":["  "]},{"start":{"row":83,"column":0},"end":{"row":83,"column":2},"action":"remove","lines":["  "]},{"start":{"row":98,"column":0},"end":{"row":98,"column":2},"action":"remove","lines":["  "]},{"start":{"row":102,"column":0},"end":{"row":105,"column":9},"action":"insert","lines":["","<<<<<<<<< saved version","let toWirelessTransmitter = (id, status) => {","========="]},{"start":{"row":107,"column":38},"end":{"row":108,"column":23},"action":"insert","lines":["",">>>>>>>>> local version"]},{"start":{"row":127,"column":0},"end":{"row":130,"column":0},"action":"insert","lines":["<<<<<<<<< saved version","","=========",""]},{"start":{"row":185,"column":0},"end":{"row":186,"column":0},"action":"insert","lines":[">>>>>>>>> local version",""]},{"start":{"row":189,"column":0},"end":{"row":189,"column":23},"action":"insert","lines":["<<<<<<<<< saved version"]},{"start":{"row":190,"column":1},"end":{"row":194,"column":23},"action":"insert","lines":[";","=========","=========","=========",">>>>>>>>> local version"]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":47,"column":9},"end":{"row":47,"column":9},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1523540598870}